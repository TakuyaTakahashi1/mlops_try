name: CI notify PR on success

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: read
  issues: write

jobs:
  notify:
    # CI が成功したときだけ実行
    if: ${{ github.event.workflow_run && github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Comment to PR that CI finished
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // payload ガード（未定義なら静かに終了）
            const wr = (context.payload && context.payload.workflow_run) ? context.payload.workflow_run : null;
            if (!wr) {
              core.info('No workflow_run payload. Exit gracefully.');
              return;
            }

            // 固定ブランチのオープンPRを探す
            const prs = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: 'open', head: `${owner}:chore/daily-scrape`
            });
            if (!prs.length) {
              core.info('No open PR from chore/daily-scrape. Skip.');
              return;
            }

            const pr = prs[0];
            const body =
              `✅ CI passed for \`${wr.head_branch}\`.\n\n` +
              `Run: ${wr.html_url}`;

            await github.rest.issues.createComment({
              owner, repo, issue_number: pr.number, body
            });
